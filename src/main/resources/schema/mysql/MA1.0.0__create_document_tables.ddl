/* ============================================================
 * Tables
 *  - TB_APPLICATION_DOCUMENT
 *  - TB_APPLICATION_DOCUMENT_BODY
 *  - TB_APPLICATION_DOCUMENT_BODY_VERSION
 *  - TB_APPLICATION_DOCUMENT_VERSION
 *  - TB_APPLICATION_DOCUMENT_PROPERTY
 *
 * FK policy (권장)
 *  - BODY / BODY_VERSION / VERSION 은 DOCUMENT에 종속 (ON DELETE CASCADE)
 *  - PROPERTY는 특정 문서버전(DOCUMENT_ID, VERSION_ID)에 종속 (ON DELETE CASCADE)
 * ============================================================ */

CREATE TABLE TB_APPLICATION_DOCUMENT (
    DOCUMENT_ID     INTEGER NOT NULL AUTO_INCREMENT,
    OBJECT_TYPE     INTEGER NOT NULL,
    OBJECT_ID       INTEGER NOT NULL,
    PARENT_DOCUMENT_ID INTEGER NULL,
    SORT_ORDER      INTEGER DEFAULT 0,
    NAME            VARCHAR(255) NOT NULL,
    VERSION_ID      INTEGER DEFAULT 1 NOT NULL,
    USER_ID         INTEGER NOT NULL,
    READ_COUNT      INTEGER DEFAULT 0 NOT NULL,
    PATTERN         VARCHAR(255) NULL,
    CREATION_DATE   DATETIME NULL,
    MODIFIED_DATE   DATETIME NULL,
    CONSTRAINT TB_APPLICATION_DOCUMENT_PK PRIMARY KEY (DOCUMENT_ID)
) ENGINE=InnoDB;

CREATE UNIQUE INDEX TB_APPLICATION_DOCUMENT_IDX1 ON TB_APPLICATION_DOCUMENT (NAME);

CREATE INDEX TB_APPLICATION_DOCUMENT_IDX2 ON TB_APPLICATION_DOCUMENT (
    OBJECT_TYPE,
    OBJECT_ID,
    DOCUMENT_ID
);

CREATE INDEX TB_APPLICATION_DOCUMENT_IDX_PARENT
    ON TB_APPLICATION_DOCUMENT (PARENT_DOCUMENT_ID, SORT_ORDER, DOCUMENT_ID);

CREATE INDEX TB_APPLICATION_DOCUMENT_IDX3 ON TB_APPLICATION_DOCUMENT (USER_ID);


CREATE TABLE TB_APPLICATION_DOCUMENT_BODY (
    BODY_ID     INTEGER NOT NULL,
    DOCUMENT_ID INTEGER NOT NULL,
    BODY_TYPE   INTEGER NOT NULL,
    BODY_TEXT   LONGTEXT,
    CONSTRAINT TB_APPLICATION_DOCUMENT_BODY_PK PRIMARY KEY (BODY_ID),
    CONSTRAINT TB_APPLICATION_DOCUMENT_BODY_FK1
        FOREIGN KEY (DOCUMENT_ID)
        REFERENCES TB_APPLICATION_DOCUMENT (DOCUMENT_ID)
        ON DELETE CASCADE
        ON UPDATE CASCADE
) ENGINE=InnoDB;


CREATE TABLE TB_APPLICATION_DOCUMENT_BODY_VERSION (
    BODY_ID     INTEGER NOT NULL,
    DOCUMENT_ID INTEGER NOT NULL,
    VERSION_ID  INTEGER DEFAULT 1 NOT NULL,
    CONSTRAINT TB_APPLICATION_DOCUMENT_BODY_VERSION_PK
        PRIMARY KEY (BODY_ID, DOCUMENT_ID, VERSION_ID),
    CONSTRAINT TB_APPLICATION_DOCUMENT_BODY_VERSION_FK1
        FOREIGN KEY (DOCUMENT_ID)
        REFERENCES TB_APPLICATION_DOCUMENT (DOCUMENT_ID)
        ON DELETE CASCADE
        ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE INDEX TB_APPLICATION_DOCUMENT_BODY_VERSION_IDX1
    ON TB_APPLICATION_DOCUMENT_BODY_VERSION (DOCUMENT_ID, VERSION_ID);


CREATE TABLE TB_APPLICATION_DOCUMENT_VERSION (
    DOCUMENT_ID     INTEGER NOT NULL,
    VERSION_ID      INTEGER DEFAULT 1 NOT NULL,
    STATE           VARCHAR(20),
    TITLE           VARCHAR(255),
    SECURED         TINYINT DEFAULT 1,
    CONTENT_TYPE    VARCHAR(255),
    TEMPLATE        VARCHAR(255),
    SCRIPT          VARCHAR(255),
    PATTERN         VARCHAR(255),
    SUMMARY         VARCHAR(4000),
    USER_ID         INTEGER NOT NULL,
    CREATION_DATE   DATETIME NULL,
    MODIFIED_DATE   DATETIME NULL,
    CONSTRAINT TB_APPLICATION_DOCUMENT_VERSION_PK PRIMARY KEY (DOCUMENT_ID, VERSION_ID),
    CONSTRAINT TB_APPLICATION_DOCUMENT_VERSION_FK1
        FOREIGN KEY (DOCUMENT_ID)
        REFERENCES TB_APPLICATION_DOCUMENT (DOCUMENT_ID)
        ON DELETE CASCADE
        ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE INDEX TB_APPLICATION_DOCUMENT_VERSION_IDX1 ON TB_APPLICATION_DOCUMENT_VERSION (CREATION_DATE);
CREATE INDEX TB_APPLICATION_DOCUMENT_VERSION_IDX2 ON TB_APPLICATION_DOCUMENT_VERSION (MODIFIED_DATE);
CREATE INDEX TB_APPLICATION_DOCUMENT_VERSION_IDX3 ON TB_APPLICATION_DOCUMENT_VERSION (TITLE);
CREATE INDEX TB_APPLICATION_DOCUMENT_VERSION_IDX4 ON TB_APPLICATION_DOCUMENT_VERSION (DOCUMENT_ID, STATE);


CREATE TABLE TB_APPLICATION_DOCUMENT_PROPERTY (
    DOCUMENT_ID     INTEGER NOT NULL,
    VERSION_ID      INTEGER DEFAULT 1 NOT NULL,
    PROPERTY_NAME   VARCHAR(100) NOT NULL,
    PROPERTY_VALUE  VARCHAR(1024) NOT NULL,
    CONSTRAINT TB_APPLICATION_DOCUMENT_PROPERTY_PK PRIMARY KEY (
        DOCUMENT_ID,
        VERSION_ID,
        PROPERTY_NAME
    ),
    CONSTRAINT TB_APPLICATION_DOCUMENT_PROPERTY_FK1
        FOREIGN KEY (DOCUMENT_ID, VERSION_ID)
        REFERENCES TB_APPLICATION_DOCUMENT_VERSION (DOCUMENT_ID, VERSION_ID)
        ON DELETE CASCADE
        ON UPDATE CASCADE
) ENGINE=InnoDB;

ALTER TABLE `TB_APPLICATION_DOCUMENT_PROPERTY` COMMENT 'PAGE 프로퍼티 테이블';


CREATE TABLE TB_APPLICATION_DOCUMENT_BLOCK (
    BLOCK_ID        INTEGER NOT NULL AUTO_INCREMENT,
    DOCUMENT_ID     INTEGER NOT NULL,
    PARENT_BLOCK_ID INTEGER NULL,
    BLOCK_TYPE      VARCHAR(50) NOT NULL,
    BLOCK_DATA      LONGTEXT,
    SORT_ORDER      INTEGER DEFAULT 0,
    IS_DELETED      TINYINT DEFAULT 0,
    USER_ID         INTEGER NOT NULL,
    CREATION_DATE   DATETIME NULL,
    MODIFIED_DATE   DATETIME NULL,
    CONSTRAINT TB_APPLICATION_DOCUMENT_BLOCK_PK PRIMARY KEY (BLOCK_ID),
    CONSTRAINT TB_APPLICATION_DOCUMENT_BLOCK_FK1
        FOREIGN KEY (DOCUMENT_ID)
        REFERENCES TB_APPLICATION_DOCUMENT (DOCUMENT_ID)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    CONSTRAINT TB_APPLICATION_DOCUMENT_BLOCK_FK2
        FOREIGN KEY (PARENT_BLOCK_ID)
        REFERENCES TB_APPLICATION_DOCUMENT_BLOCK (BLOCK_ID)
        ON DELETE SET NULL
        ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE INDEX TB_APPLICATION_DOCUMENT_BLOCK_IDX1
    ON TB_APPLICATION_DOCUMENT_BLOCK (DOCUMENT_ID, SORT_ORDER, BLOCK_ID);

CREATE INDEX TB_APPLICATION_DOCUMENT_BLOCK_IDX2
    ON TB_APPLICATION_DOCUMENT_BLOCK (PARENT_BLOCK_ID);


CREATE TABLE TB_APPLICATION_DOCUMENT_BLOCK_VERSION (
    BLOCK_ID        INTEGER NOT NULL,
    DOCUMENT_ID     INTEGER NOT NULL,
    VERSION_ID      INTEGER NOT NULL,
    PARENT_BLOCK_ID INTEGER NULL,
    BLOCK_TYPE      VARCHAR(50) NOT NULL,
    BLOCK_DATA      LONGTEXT,
    SORT_ORDER      INTEGER DEFAULT 0,
    IS_DELETED      TINYINT DEFAULT 0,
    USER_ID         INTEGER NOT NULL,
    CREATION_DATE   DATETIME NULL,
    CONSTRAINT TB_APPLICATION_DOCUMENT_BLOCK_VERSION_PK
        PRIMARY KEY (BLOCK_ID, DOCUMENT_ID, VERSION_ID),
    CONSTRAINT TB_APPLICATION_DOCUMENT_BLOCK_VERSION_FK1
        FOREIGN KEY (DOCUMENT_ID, VERSION_ID)
        REFERENCES TB_APPLICATION_DOCUMENT_VERSION (DOCUMENT_ID, VERSION_ID)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    CONSTRAINT TB_APPLICATION_DOCUMENT_BLOCK_VERSION_FK2
        FOREIGN KEY (BLOCK_ID)
        REFERENCES TB_APPLICATION_DOCUMENT_BLOCK (BLOCK_ID)
        ON DELETE CASCADE
        ON UPDATE CASCADE,
    CONSTRAINT TB_APPLICATION_DOCUMENT_BLOCK_VERSION_FK3
        FOREIGN KEY (PARENT_BLOCK_ID)
        REFERENCES TB_APPLICATION_DOCUMENT_BLOCK (BLOCK_ID)
        ON DELETE SET NULL
        ON UPDATE CASCADE
) ENGINE=InnoDB;

CREATE INDEX TB_APPLICATION_DOCUMENT_BLOCK_VERSION_IDX1
    ON TB_APPLICATION_DOCUMENT_BLOCK_VERSION (DOCUMENT_ID, VERSION_ID, SORT_ORDER, BLOCK_ID);
